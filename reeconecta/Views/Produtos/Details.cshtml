@using System.Security.Claims
@model reeconecta.Models.Produto

@{
    Layout = null;
    ViewData["Title"] = "Detalhes do Produto";
    var usuarioLogadoId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    bool isAnunciante = usuarioLogadoId == Model.AnuncianteId.ToString();
    var telefoneLimpo = Model.Usuario?.Telefone01?
        .Replace("(", "").Replace(")", "").Replace("-", "").Replace(" ", "");
}

<div class="modal-body px-4">

    <div class="row">

        <!-- Imagem -->
        <div class="col-md-4 text-center">
            <div class="p-2 bg-light rounded border" style="max-height: 300px;">
                <img src="@Model.Imagem"
                     alt="Imagem do produto"
                     class="img-fluid rounded"
                     style="max-height: 260px; object-fit: contain;" />
            </div>
        </div>

        <!-- Informações -->
        <div class="col-md-8">

            <h3 class="fw-bold mb-1">@Model.Titulo</h3>

            <!-- 👉 Nome do anunciante aqui -->
            <p class="text-muted mb-3" style="font-size: 0.95rem;">
                Anunciado por: <strong>@Model.Usuario?.Nome</strong>
            </p>

            <div class="mb-3">
                <strong class="text-secondary">Preço:</strong>
                <div class="fs-5 fw-semibold text-success">R$ @Model.Preco.ToString("N2")</div>
            </div>

            <div class="mb-3">
                <strong class="text-secondary">Condição:</strong><br />
                @Model.Condicao
            </div>

            <div class="mb-3">
                <strong class="text-secondary">Descrição:</strong>
                <p class="mb-1"><em>@Model.Descricao</em></p>
            </div>

            <div class="mb-4">
                <strong class="text-secondary">Localização:</strong><br />
                @Model.Bairro - @Model.Cidade
            </div>

            <!-- Botão WhatsApp -->
            @if (!isAnunciante && !string.IsNullOrWhiteSpace(telefoneLimpo))
            {
                <a href="https://wa.me/@telefoneLimpo"
                   target="_blank"
                   class="btn btn-success w-100 py-2 fw-semibold shadow-sm">
                    <i class="bi bi-whatsapp me-2"></i> Entrar em contato pelo WhatsApp
                </a>
            }
            else
            {
                <br />
                <div class="mt-3">
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-link">
                        <i class="bi bi-pencil fs-5 text-primary"></i>
                    </a>

                    <form asp-action="Delete" asp-route-id="@Model.Id" method="post" class="d-inline">
                        <button type="submit" class="btn">
                            <i class="bi bi-trash fs-5 text-danger"></i>
                        </button>
                    </form>
                </div>
                <hr />
                <h5>Interessados neste produto</h5>

                @if (!Model.ReservasProduto?.Any() ?? true)
                {
                    <p class="text-muted">Nenhum interessado até o momento.</p>
                }
                else
                {
                    <div class="list-group mt-3">
                        @foreach (var reserva in Model.ReservasProduto)
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>@reserva.Usuario?.Nome</strong><br />
                                    Reservado em @reserva.DataReserva.ToString("dd/MM/yyyy")<br />
                                    Status:
                                    @switch (reserva.Status)
                                    {
                                        case reeconecta.Models.StatusReserva.Pendente:
                                            <span class="badge bg-warning text-dark">Pendente</span>
                                            ;
                                            break;
                                        case reeconecta.Models.StatusReserva.Confirmada:
                                            <span class="badge bg-success">Confirmada</span>
                                            ;
                                            break;
                                        case reeconecta.Models.StatusReserva.Cancelada:
                                            <span class="badge bg-danger">Cancelada</span>
                                            ;
                                            break;
                                    }

                                    @{
                                        var telefoneLimpo2 = reserva.Usuario?.Telefone01?
                                        .Replace("(", "").Replace(")", "")
                                        .Replace("-", "").Replace(" ", "");
                                    }

                                    @if (reserva.Status == reeconecta.Models.StatusReserva.Confirmada)
                                    {
                                        <a href="https://wa.me/@telefoneLimpo2" target="_blank"
                                           class="btn btn-outline-success w-100 mt-4" style="font-weight: 600;">
                                            <i class="bi bi-whatsapp me-2"></i> Entre em contato com o interessado
                                        </a>
                                    }

                                </div>
                                <div>
                                    @if (reserva.Status == reeconecta.Models.StatusReserva.Pendente)
                                    {
                                        <a asp-controller="Produtos" asp-action="Confirmar" asp-route-id="@reserva.Id"
                                           class="btn btn-sm btn-success me-2" title="Confirmar reserva">
                                            <i class="bi bi-check-lg"></i>
                                        </a>
                                        <a asp-controller="Produtos" asp-action="Recusar" asp-route-id="@reserva.Id"
                                           class="btn btn-sm btn-danger" title="Recusar reserva">
                                            <i class="bi bi-x-lg"></i>
                                        </a>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    </div>
</div>
