@model reeconecta.Models.Ponto

@{
    ViewData["Title"] = "Editar Ponto de Coleta";
}

<link rel="stylesheet" href="~/css/produto-form.css" />

<div class="container my-5">

    <div class="text-center mb-5">
        <h1 class="fw-bold text-dark">
            Editar Ponto de Coleta
        </h1>
        <p class="lead mt-2">
            Atualize as informações do ponto de coleta cadastrado ♻️
        </p>
    </div>

    <div class="form-section shadow-sm border-0 rounded-4 p-4 p-md-5">
        <div class="card-body px-4 px-md-5 py-5">

            <form asp-action="Edit" enctype="multipart/form-data">
                <input type="hidden" asp-for="Id" />

                <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4"></div>

                <div class="row g-4">

                    <div class="col-md-6">
                        <label asp-for="NomePonto" class="form-label">Nome do Ponto</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-geo-alt"></i></span>
                            <input asp-for="NomePonto" class="form-control input" />
                        </div>
                        <span asp-validation-for="NomePonto" class="text-danger small"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Tipo" class="form-label">Tipo do Ponto</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-tags"></i></span>
                            <select asp-for="Tipo" class="form-select input" asp-items="Html.GetEnumSelectList<TipoPonto>()">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <span asp-validation-for="Tipo" class="text-danger small"></span>
                    </div>

                    <div class="col-12">
                        <label asp-for="DescricaoPonto" class="form-label">Descrição</label>
                        <textarea asp-for="DescricaoPonto" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="DescricaoPonto" class="text-danger small"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="CepPonto" class="form-label">CEP</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-mailbox"></i></span>
                            <input asp-for="CepPonto" class="form-control input" id="cep-ponto" placeholder="Ex.: 30123-456" />
                        </div>
                        <span asp-validation-for="CepPonto" class="text-danger small"></span>
                    </div>

                    <div class="col-md-8">
                        <label class="form-label">Endereço</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-signpost"></i></span>
                            <input id="endereco-logradouro-ponto" class="form-control input" readonly />
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Número</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-hash"></i></span>
                            <input id="endereco-numero-ponto" class="form-control input" placeholder="Nº" />
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Complemento</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-building"></i></span>
                            <input id="endereco-complemento-ponto" class="form-control input" placeholder="Apto, sala, etc." />
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Bairro</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-map"></i></span>
                            <input id="endereco-bairro-ponto" class="form-control input" readonly />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Cidade</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-buildings"></i></span>
                            <input id="endereco-cidade-ponto" class="form-control input" readonly />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">UF</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-flag"></i></span>
                            <input id="endereco-uf-ponto" class="form-control input" readonly />
                        </div>
                    </div>

                    <input type="hidden" asp-for="EnderecoPonto" id="endereco-completo-ponto" />

                    <div class="col-md-6">
                        <label asp-for="TelefoneP01" class="form-label">Telefone 01</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-telephone"></i></span>
                            <input asp-for="TelefoneP01" class="form-control input" id="tel-ponto-01" />
                        </div>
                        <span asp-validation-for="TelefoneP01" class="text-danger small"></span>

                        <div class="form-check mt-2">
                            <input class="form-check-input" asp-for="WppTelP1" />
                            <label class="form-check-label">É WhatsApp?</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="TelefoneP02" class="form-label">Telefone 02</label>
                        <div class="input-group grupo">
                            <span class="input-group-text icone"><i class="bi bi-telephone-plus"></i></span>
                            <input asp-for="TelefoneP02" class="form-control input" id="tel-ponto-02" />
                        </div>
                        <span asp-validation-for="TelefoneP02" class="text-danger small"></span>

                        <div class="form-check mt-2">
                            <input class="form-check-input" asp-for="WppTelP2" />
                            <label class="form-check-label">É WhatsApp?</label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Imagem do Ponto</label>

                        <label for="ImagemFile" class="upload-area">
                            <i class="bi bi-cloud-upload fs-1"></i>
                            <p class="mt-2">Clique para selecionar uma nova imagem</p>
                        </label>

                        <input type="file" name="ImagemFile" id="ImagemFile" class="d-none"
                               accept="image/*" onchange="previewImagem(event)" />
                    </div>

                    <div class="col-md-6 text-center">
                        <label class="form-label">Pré-visualização</label>

                        <div class="preview-container shadow-sm">
                            <img id="preview" class="preview-img"
                                 src="@(string.IsNullOrEmpty(Model.Imagem)
                                                                    ? "https://via.placeholder.com/250x250?text=Prévia"
                                                                    : Model.Imagem)" />
                        </div>
                    </div>

                </div>

                <div class="mt-5 text-center">
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>

                    <button type="submit" class="btn btn-warning ms-3 shadow">
                        <i class="bi bi-pencil-square"></i> Atualizar Ponto
                    </button>
                </div>

            </form>
        </div>
    </div>

</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // ELEMENTOS DE ENDEREÇO
            const cepInput = document.getElementById("cep-ponto");
            const enderecoInput = document.getElementById("endereco-logradouro-ponto");
            const bairroInput = document.getElementById("endereco-bairro-ponto");
            const cidadeInput = document.getElementById("endereco-cidade-ponto");
            const ufInput = document.getElementById("endereco-uf-ponto");
            const numeroInput = document.getElementById("endereco-numero-ponto");
            const complementoInput = document.getElementById("endereco-complemento-ponto");
            const enderecoCompletoInput = document.getElementById("endereco-completo-ponto");

            // ELEMENTOS DE TELEFONE
            const telefone1 = document.getElementById("tel-ponto-01");
            const telefone2 = document.getElementById("tel-ponto-02");

            // FUNÇÃO: Extrair componentes do endereço completo ao carregar a página
            function extrairComponentesEndereço() {
                const enderecoCompleto = enderecoCompletoInput.value;
                if (!enderecoCompleto) return;

                // Padrão: "Logradouro, nº Número (Complemento), Bairro - Cidade / UF"
                // Extrai logradouro (antes da primeira vírgula)
                const partes = enderecoCompleto.split(',');
                if (partes.length > 0) {
                    enderecoInput.value = partes[0].trim();
                }

                // Extrai número (após "nº")
                const numeroMatch = enderecoCompleto.match(/nº\s*(\d+)/);
                if (numeroMatch) {
                    numeroInput.value = numeroMatch[1];
                }

                // Extrai complemento (dentro de parênteses)
                const complementoMatch = enderecoCompleto.match(/\(([^)]+)\)/);
                if (complementoMatch) {
                    complementoInput.value = complementoMatch[1];
                }

                // Extrai bairro (antes do hífen)
                const bairroMatch = enderecoCompleto.match(/,\s*([^,]+)\s*-/);
                if (bairroMatch) {
                    bairroInput.value = bairroMatch[1].trim();
                }

                // Extrai cidade (após hífen, antes da barra)
                const cidadeMatch = enderecoCompleto.match(/\s-\s*([^/]+)/);
                if (cidadeMatch) {
                    cidadeInput.value = cidadeMatch[1].trim();
                }

                // Extrai UF (após barra)
                const ufMatch = enderecoCompleto.match(/\/\s*([A-Z]{2})/);
                if (ufMatch) {
                    ufInput.value = ufMatch[1];
                }
            }

            // FUNÇÃO: Limpar campos de endereço
            function limparCampos() {
                enderecoInput.value = "";
                bairroInput.value = "";
                cidadeInput.value = "";
                ufInput.value = "";
            }

            // FUNÇÃO: Montar endereço completo
            function montarEndereco() {
                const logradouro = enderecoInput.value.trim();
                const numero = numeroInput.value.trim();
                const complemento = complementoInput.value.trim();
                const bairro = bairroInput.value.trim();
                const cidade = cidadeInput.value.trim();
                const uf = ufInput.value.trim();

                let endereco = `${logradouro}`;
                if (numero) endereco += `, nº ${numero}`;
                if (complemento) endereco += ` (${complemento})`;
                if (bairro) endereco += `, ${bairro}`;
                if (cidade || uf) endereco += ` - ${cidade}${uf ? " / " + uf : ""}`;

                if (enderecoCompletoInput) enderecoCompletoInput.value = endereco;
            }

            // MÁSCARA DE CEP
            cepInput.addEventListener("input", function () {
                let cep = this.value.replace(/\D/g, "");
                if (cep.length > 5) cep = cep.replace(/^(\d{5})(\d)/, "$1-$2");
                this.value = cep;
            });

            // BUSCA DE CEP NA API VIACEP
            cepInput.addEventListener("blur", function () {
                const cep = this.value.replace(/\D/g, "");
                if (cep.length !== 8) {
                    limparCampos();
                    alert("CEP inválido. Digite 8 números.");
                    return;
                }

                const url = `https://viacep.com.br/ws/${cep}/json/`;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.erro) {
                            limparCampos();
                            alert("CEP não encontrado.");
                            return;
                        }

                        enderecoInput.value = data.logradouro;
                        bairroInput.value = data.bairro;
                        cidadeInput.value = data.localidade;
                        ufInput.value = data.uf.toUpperCase();

                        montarEndereco();
                    })
                    .catch(() => {
                        limparCampos();
                        alert("Erro ao buscar o CEP. Tente novamente.");
                    });
            });

            // REMONTAR ENDEREÇO QUANDO CAMPOS MUDAM
            numeroInput.addEventListener("blur", montarEndereco);
            complementoInput.addEventListener("blur", montarEndereco);

            // MÁSCARA DE TELEFONE
            function aplicarMascaraTelefone(input) {
                input.addEventListener("input", function (e) {
                    let valor = e.target.value.replace(/\D/g, "");
                    if (valor.length > 11) valor = valor.slice(0, 11);

                    if (valor.length > 10) {
                        valor = valor.replace(/^(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
                    } else if (valor.length > 6) {
                        valor = valor.replace(/^(\d{2})(\d{4})(\d{0,4})/, "($1) $2-$3");
                    } else if (valor.length > 2) {
                        valor = valor.replace(/^(\d{2})(\d{0,5})/, "($1) $2");
                    } else {
                        valor = valor.replace(/^(\d*)/, "($1");
                    }

                    e.target.value = valor;
                });
            }

            if (telefone1) aplicarMascaraTelefone(telefone1);
            if (telefone2) aplicarMascaraTelefone(telefone2);

            // PREVIEW DE IMAGEM
            window.previewImagem = function (event) {
                const img = document.getElementById('preview');
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => img.src = e.target.result;
                    reader.readAsDataURL(file);
                }
            }

            // EXTRAIR COMPONENTES AO CARREGAR A PÁGINA
            extrairComponentesEndereço();

            // MONTAR ENDEREÇO AO ENVIAR FORMULÁRIO
            const form = document.querySelector("form");
            if (form) {
                form.addEventListener("submit", montarEndereco);
            }
        });
    </script>
}