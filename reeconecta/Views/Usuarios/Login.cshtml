@model reeconecta.Models.Usuario

@{
    ViewData["Title"] = "Login";
}
@{
    Layout = "_Layout";
}


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/login.css" />

<div class="espaco-login">
    <div class="card shadow-lg p-4" style="width: 380px;">
        <h3 class="text-center mb-4">Entrar</h3>

        <form asp-action="Login">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group mb-3">
                <label asp-for="Email" class="control-label"></label>
                <input asp-for="Email" class="form-control campo-login" placeholder="Seu email" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Senha" class="control-label"></label>
                <input asp-for="Senha" class="form-control campo-login" placeholder="Sua senha" />
                <span asp-validation-for="Senha" class="text-danger"></span>

                <a class="link-esqueci-senha" data-bs-toggle="modal" data-bs-target="#modalRecuperarSenha">Esqueci minha senha</a>
            </div>

            <p class="msg-erro-login">@ViewBag.Message</p>
            <div class="form-group mb-3">
                <button type="submit" class="btn btn-entrar w-100" style="margin-top: 10px">Entrar</button>
                <a class="link-criar-conta" style="margin-top: 10px" asp-controller="Usuarios" asp-action="Create">Primeiro acesso? Cadastre-se agora!</a>
            </div>
        </form>
        <!-- Modal -->
        <div class="modal fade" id="modalRecuperarSenha" tabindex="-1" aria-labelledby="modalRecuperarSenhaLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title fs-5 text-center" id="modalRecuperarSenhaLabel">Recuperar senha</h3>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-body" id="conteudoModal">

                            <div id="etapa-verificacao" style="display: block;">
                                <p style="text-align: center; padding-bottom: 10px;">Confirme os dados abaixo para alterar sua senha.</p>

                                <form id="formRecuperacaoDocEmail">
                                    <div class="form-group mb-3">
                                        <label>CPF ou CNPJ cadastrado:</label>
                                        <input type="text" id="documento" name="DocumentoRecuperacao" class="form-control campo-login" />
                                    </div>

                                    <div class="form-group mb-3">
                                        <label class="mt-3">Email cadastrado:</label>
                                        <input type="email" id="emailRec" name="EmailRecuperacao" class="form-control campo-login" />
                                    </div>

                                    <p id="erroVerificacao" class="text-danger mt-2" style="display:none;"></p>

                                    <button type="button" class="btn btn-entrar mt-3" onclick="verificarDocEmail()">Continuar</button>
                                </form>
                            </div>

                            <div id="etapa-redefinicao" style="display: none;">
                                <p>Olá, <span id="nomeUsuario"></span>! Agora você pode redefinir sua senha.</p>

                                <form id="formNovaSenha">
                                    <label>Nova senha</label>
                                    <input id="senhaNova" name="SenhaNova" type="password" class="form-control" />

                                    <label class="mt-3">Confirmar senha</label>
                                    <input id="senhaConfirm" name="Confirmar" type="password" class="form-control" />

                                    <p id="erroSenha" class="text-danger mt-2" style="display:none;"></p>
                                    <p id="sucessoSenha" class="text-success mt-2" style="display:none;"></p>

                                    <button type="button" class="btn btn-entrar mt-3" onclick="salvarNovaSenha()">Salvar nova senha</button>
                                </form>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="espaco-banner">
    <img class="img-banner" src="~/banner-945x802.png" />
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
<script>
    // Limpar modal quando fechado
    const modalRecuperarSenha = document.getElementById('modalRecuperarSenha');
    modalRecuperarSenha.addEventListener('hidden.bs.modal', function () {
        // Resetar para etapa de verificação
        document.getElementById("etapa-verificacao").style.display = "block";
        document.getElementById("etapa-redefinicao").style.display = "none";
        
        // Limpar campos
        document.getElementById("documento").value = "";
        document.getElementById("emailRec").value = "";
        document.getElementById("senhaNova").value = "";
        document.getElementById("senhaConfirm").value = "";
        
        // Limpar mensagens de erro
        document.getElementById("erroVerificacao").style.display = "none";
        document.getElementById("erroSenha").style.display = "none";
        document.getElementById("sucessoSenha").style.display = "none";
    });

    const documentoInserido = document.getElementById("documento");
    documentoInserido.addEventListener("input", function(event) {
        let doc = event.target.value.replace(/\D/g, "");

        if (doc.length <= 11) {
            if (doc.length > 9)
                doc = doc.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2})/, "$1.$2.$3-$4");
            else if (doc.length > 6)
                doc = doc.replace(/^(\d{3})(\d{3})(\d{0,3})/, "$1.$2.$3");
            else if (doc.length > 3)
                doc = doc.replace(/^(\d{3})(\d{0,3})/, "$1.$2");
        } else {
            if (doc.length > 14) doc = doc.slice(0, 14);

            if (doc.length > 12)
                doc = doc.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, "$1.$2.$3/$4-$5");
            else if (doc.length > 8)
                doc = doc.replace(/^(\d{2})(\d{3})(\d{3})(\d{0,4})/, "$1.$2.$3/$4");
            else if (doc.length > 5)
                doc = doc.replace(/^(\d{2})(\d{3})(\d{0,3})/, "$1.$2.$3");
            else if (doc.length > 2)
                doc = doc.replace(/^(\d{2})(\d{0,3})/, "$1.$2");
        }

        event.target.value = doc;
    });

    function verificarDocEmail() {
        // Limpar erros anteriores
        document.getElementById("erroVerificacao").style.display = "none";
        
        const documentoInput = document.getElementById("documento").value;
        const emailInput = document.getElementById("emailRec").value;

        // Validar campos vazios
        if (!documentoInput || !emailInput) {
            document.getElementById("erroVerificacao").innerText = "Preencha todos os campos.";
            document.getElementById("erroVerificacao").style.display = "block";
            return;
        }

        fetch('/Usuarios/ValidarRecuperacao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                Documento: documentoInput,
                Email: emailInput
            })
        })
        .then(r => {
            if (!r.ok) throw new Error('Erro na requisição');
            return r.json();
        })
        .then(data => {
            if (!data.sucesso) {
                document.getElementById("erroVerificacao").innerText = data.mensagem || "Erro ao verificar dados.";
                document.getElementById("erroVerificacao").style.display = "block";
            } else {
                document.getElementById("etapa-verificacao").style.display = "none";
                document.getElementById("etapa-redefinicao").style.display = "block";
                document.getElementById("nomeUsuario").innerText = data.nome || "Usuário";
                
                // Limpar campos de senha
                document.getElementById("senhaNova").value = "";
                document.getElementById("senhaConfirm").value = "";
                document.getElementById("erroSenha").style.display = "none";
                document.getElementById("sucessoSenha").style.display = "none";
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById("erroVerificacao").innerText = "Erro ao conectar com o servidor.";
            document.getElementById("erroVerificacao").style.display = "block";
        });
    }

    function salvarNovaSenha() {
        // Limpar mensagens anteriores
        document.getElementById("erroSenha").style.display = "none";
        document.getElementById("sucessoSenha").style.display = "none";
        
        const s1 = document.getElementById("senhaNova").value;
        const s2 = document.getElementById("senhaConfirm").value;

        // Validar campos vazios
        if (!s1 || !s2) {
            document.getElementById("erroSenha").innerText = "Preencha todos os campos de senha.";
            document.getElementById("erroSenha").style.display = "block";
            return;
        }

        // Validar comprimento mínimo
        if (s1.length < 6) {
            document.getElementById("erroSenha").innerText = "A senha deve ter no mínimo 6 caracteres.";
            document.getElementById("erroSenha").style.display = "block";
            return;
        }

        // Validar se as senhas coincidem
        if (s1 !== s2) {
            document.getElementById("erroSenha").innerText = "As senhas não coincidem.";
            document.getElementById("erroSenha").style.display = "block";
            return;
        }

        fetch('/Usuarios/SalvarNovaSenha', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ NovaSenha: s1 })
        })
        .then(r => {
            if (!r.ok) throw new Error('Erro na requisição');
            return r.json();
        })
        .then(data => {
            if (!data.sucesso) {
                document.getElementById("erroSenha").innerText = data.mensagem || "Erro ao salvar senha.";
                document.getElementById("erroSenha").style.display = "block";
            } else {
                document.getElementById("sucessoSenha").innerText = "Senha alterada com sucesso! Redirecionando...";
                document.getElementById("sucessoSenha").style.display = "block";
                
                // Fechar modal e redirecionar após 2 segundos
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalRecuperarSenha'));
                    if (modal) modal.hide();
                    window.location.href = '/Usuarios/Login';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById("erroSenha").innerText = "Erro ao conectar com o servidor.";
            document.getElementById("erroSenha").style.display = "block";
        });
    }
</script>
